<div id="show_command">
    <%= link_to t('common.title.back'), :creditcards %>
</div>

<% newest = Time.zone.now %>
<% oldest = Time.zone.now - 1.year %>

<% newest = Creditcard.newest_used_source %>
<% oldest = Creditcard.oldest_used_source %>

<% period = Time.zone.parse("#{newest.year}-#{newest.month}-01 00:00:00") %>
<table id="list-table">
  <thead>
    <tr>
      <th>날짜</th>
      <th>카드내역</th>
    </tr>
  </thead>
  <tbody>
    <% while period > oldest %>
      <tr>
        <td>
          <%= period.strftime("%Y.%m") %>
        </td>
        <td>
          <table>
            <thead>
              <tr>
                <th><%= Creditcard.human_attribute_name(:cardholder) %></th>
                <th><%= Creditcard.human_attribute_name(:cardno) %></th>
                <th><%= Creditcard.human_attribute_name(:nickname) %></th>
                <th><%= Creditcard.human_attribute_name(:total) %></th>
              </tr>
            </thead>
              <% Creditcard.all.each do |card| %>
                <tr>
                  <td><%= card.cardholder %></td>
                  <td><%= card.cardno %></td>
                  <td><%= card.nickname %></td>
                  <% used_sources = card.card_used_sources.where(approved_at: period.all_month) %>
                  <td><%= number_to_currency used_sources.total_price %></td>
                </tr>
              <% end %>
              <tr>
                <td><%= CardUsedSource.human_attribute_name(:total) %></td>
                <td></td>
                <td></td>
                <% used_sources = CardUsedSource.where(approved_at: period.all_month) %>
                <td><%= number_to_currency used_sources.total_price %></td>
              </tr>
            <tbody>
            </tbody>
          </table>
        </td>
      </tr>
      <% period -= 1.month %>
    <% end %>
  </tbody>
</table>
